AWSTemplateFormatVersion: "2010-09-09"
Description: "Free-tier WordPress on EC2 with local MySQL"

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: EC2 key pair for SSH access

Resources:

  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro         # free tier eligible
      ImageId: ami-0c02fb55956c7d316 # Amazon Linux 2 (update if needed)
      KeyName: !Ref KeyPairName
      SecurityGroupIds:
        - !Ref EC2SecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y

          # Install Apache & PHP
          yum install -y httpd php php-mysqlnd wget unzip

          systemctl enable httpd
          systemctl start httpd

          # Install MySQL (MariaDB)
          yum install -y mariadb mariadb-server
          systemctl enable mariadb
          systemctl start mariadb

          # Secure MySQL (simple setup)
          mysql -e "UPDATE mysql.user SET Password=PASSWORD('wordpresspass') WHERE User='root';"
          mysql -e "DELETE FROM mysql.user WHERE User='';"
          mysql -e "DROP DATABASE IF EXISTS test;"
          mysql -e "FLUSH PRIVILEGES;"

          # Create WP database
          mysql -uroot -pwordpresspass -e "CREATE DATABASE wordpress;"

          cd /var/www/html

          # Install WordPress
          wget https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz
          cp -r wordpress/* .
          rm -rf wordpress latest.tar.gz

          # Configure WordPress
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/root/" wp-config.php
          sed -i "s/password_here/wordpresspass/" wp-config.php
          sed -i "s/localhost/localhost/" wp-config.php

          chown -R apache:apache /var/www/html
          chmod -R 755 /var/www/html

Outputs:
  WebsiteURL:
    Description: WordPress site URL
    Value: !Sub "http://${EC2Instance.PublicDnsName}"
